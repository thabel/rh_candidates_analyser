# ðŸš€ Deployment Checklist - Symfony Candidate Scoring Backend

## Pre-Deployment Verification

### âœ… Files Present and Ready
- [x] **setup.sh** (19 KB) - Main installation script
- [x] **cleanup.sh** (1.7 KB) - Safe removal script
- [x] **.env.example** - Environment template
- [x] **SETUP_GUIDE.md** - Quick start guide
- [x] **API_EXAMPLES.md** - API documentation with examples
- [x] **README.md.template** - Full documentation (generated by setup.sh)
- [x] **docker-compose.yml.template** - Docker configuration template
- [x] **dockerfile.php.template** - PHP Dockerfile
- [x] **dockerfile.nginx.template** - Nginx Dockerfile
- [x] **nginx.conf.template** - Nginx configuration

### âœ… Setup.sh Contains

The setup script will automatically generate:

1. **Symfony 7.0 Project Structure**
   - [x] Public directory with index.php
   - [x] Source directory (src/)
   - [x] Config directory with Symfony configuration
   - [x] Var directory for cache/logs
   - [x] Composer.json with all dependencies

2. **Application Code**
   - [x] CandidateAnalysisController.php
   - [x] GeminiAnalysisService.php
   - [x] CandidateAnalysisRequest.php (DTO)
   - [x] CandidateAnalysisResponse.php (DTO)
   - [x] GeminiException.php

3. **Configuration**
   - [x] nelmio_cors.yaml (CORS settings)
   - [x] .env file with environment variables
   - [x] README.md with full documentation

4. **Docker Files**
   - [x] docker/php/Dockerfile
   - [x] docker/nginx/Dockerfile
   - [x] docker/nginx/default.conf
   - [x] docker-compose.yml

---

## Deployment Steps

### Step 1: Verify Docker Installation
```bash
# Check Docker
docker --version
# Expected: Docker version 20.10.x or higher

# Check Docker Compose
docker-compose --version
# Expected: Docker Compose version 2.0.x or higher
```

### Step 2: Run Setup Script
```bash
cd /home/ubuntu/to_delete
bash setup.sh
```

**Expected Output:**
```
ðŸš€ Starting Symfony Backend Setup (Docker-First)...

[1/4] Checking Docker installation...
âœ“ Docker version: Docker version 20.x.x
âœ“ Docker Compose version: Docker Compose version 2.x.x

[2/4] Creating Symfony 7.0 project with Docker...
(Project creation in progress...)

[3/4] Installing required Symfony packages...
(Installation in progress...)

[4/4] Setting up project structure...
âœ“ Created DTOs, Service, Controller, and Exception classes
âœ“ Created CORS configuration
âœ“ Created Docker configuration (Dockerfile, docker-compose.yml, nginx.conf)
âœ“ Created docker-compose.yml and README.md

âœ… Setup completed successfully!
```

â±ï¸ **Duration:** 5-10 minutes

### Step 3: Configure Environment
```bash
# Copy template to actual environment file
cp .env.example .env

# Edit and add your Gemini API key
nano .env
```

**Required Change:**
```env
GEMINI_API_KEY=your_actual_gemini_api_key_here
```

**Optional Changes:**
```env
APP_ENV=dev          # Keep for development, change to 'prod' for production
APP_DEBUG=1          # Keep for development, set to 0 for production
APP_SECRET=...       # Change to random 32+ character string for production
```

### Step 4: Build Docker Images
```bash
docker-compose build
```

**Expected Output:**
```
Building php
Step 1/12 : FROM php:8.2-fpm
...
Successfully tagged candidate-scoring-php:latest

Building nginx
Step 1/3 : FROM nginx:latest
...
Successfully tagged candidate-scoring-nginx:latest
```

### Step 5: Start Containers
```bash
docker-compose up -d
```

**Expected Output:**
```
Creating candidate-scoring-php ... done
Creating candidate-scoring-nginx ... done
```

### Step 6: Verify Installation
```bash
# Test health endpoint
curl -X GET http://localhost:8000/api/health

# Expected response:
# {"status":"ok"}
```

### Step 7: Test Full Analysis
```bash
curl -X POST http://localhost:8000/api/analyze-candidate \
  -H "Content-Type: application/json" \
  -d '{
    "jobDescription": "Senior PHP Developer with 5+ years Symfony experience required.",
    "candidateCV": "Jane Doe\n\nExperience:\nSenior PHP Developer - 8 years\nSymfony expertise - 5 years"
  }'

# Expected response:
# {"score":85,"summary":"...","positives":[...],"negatives":[...]}
```

---

## Post-Deployment Verification

### âœ… Container Status
```bash
docker-compose ps
# Both php and nginx should show "Up"
```

### âœ… Check Logs
```bash
# PHP logs
docker-compose logs php

# Nginx logs
docker-compose logs nginx

# Follow logs in real-time
docker-compose logs -f
```

### âœ… Verify API Endpoints

1. **Health Check**
   ```bash
   curl http://localhost:8000/api/health
   # Should return: {"status":"ok"}
   ```

2. **Analyze Candidate**
   ```bash
   curl -X POST http://localhost:8000/api/analyze-candidate \
     -H "Content-Type: application/json" \
     -d '{
       "jobDescription": "Description with 50+ characters...",
       "candidateCV": "CV with 50+ characters..."
     }'
   # Should return: {"score":XX,"summary":"...","positives":[...],"negatives":[...]}
   ```

3. **Test CORS**
   ```bash
   # From your React app (different origin)
   curl -X OPTIONS http://localhost:8000/api/analyze-candidate \
     -H "Origin: http://localhost:3000"
   # Should return CORS headers
   ```

### âœ… Test with React Frontend
```javascript
// From your React app (http://localhost:3000)
fetch('http://localhost:8000/api/analyze-candidate', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    jobDescription: '...',
    candidateCV: '...'
  })
})
  .then(r => r.json())
  .then(data => console.log(data))
  .catch(e => console.error(e));
```

---

## Common Deployment Issues

### Issue: Port 8000 Already in Use
```bash
# Change port in docker-compose.yml
nano docker-compose.yml
# Change "8000:80" to "8080:80" or another port

# Rebuild and restart
docker-compose down
docker-compose up -d
```

### Issue: Docker Daemon Not Running
```bash
# Start Docker daemon
sudo systemctl start docker
# or use Docker Desktop on Mac/Windows
```

### Issue: API Returns 502 (Bad Gateway)
```bash
# Check if PHP container is running
docker-compose ps

# Check PHP logs
docker-compose logs php

# Restart containers
docker-compose down
docker-compose up -d
```

### Issue: Gemini API Returns 401 Unauthorized
```bash
# Verify API key in .env
cat .env | grep GEMINI_API_KEY

# Restart containers to load new .env
docker-compose restart

# Check if key is being read
docker-compose exec php printenv GEMINI_API_KEY
```

### Issue: CORS Error from Frontend
```bash
# Check CORS configuration
cat config/packages/nelmio_cors.yaml

# Update to allow your frontend domain
# Edit docker-compose.yml and rebuild
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

---

## Production Deployment Checklist

Before deploying to production, ensure:

- [ ] `APP_ENV=prod` in .env
- [ ] `APP_DEBUG=0` in .env
- [ ] `APP_SECRET` changed to random 32+ character string
- [ ] `GEMINI_API_KEY` stored in secure secrets management
- [ ] CORS configured to allow only your frontend domain
- [ ] HTTPS/SSL certificate configured in Nginx
- [ ] Rate limiting implemented for `/api/analyze-candidate`
- [ ] Error logging configured to file (not console)
- [ ] Database backups scheduled (if using database)
- [ ] Monitoring and alerting set up
- [ ] Container registry (Docker Hub/ECR) set up for images
- [ ] CI/CD pipeline configured for auto-deployment

**Production docker-compose.yml changes:**
```yaml
services:
  php:
    image: your-registry/candidate-scoring-php:latest
    environment:
      - APP_ENV=prod
      - APP_DEBUG=0
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  nginx:
    image: your-registry/candidate-scoring-nginx:latest
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

---

## Backup and Recovery

### Backup Production Data
```bash
# Backup docker volumes
docker-compose down
tar -czf backup.tar.gz docker/

# Backup .env
cp .env env-backup.txt

# Restore if needed
tar -xzf backup.tar.gz
cp env-backup.txt .env
docker-compose up -d
```

---

## Cleanup and Removal

When no longer needed:

```bash
bash cleanup.sh
```

This will:
- Stop all Docker containers
- Remove volumes
- Delete project files
- Keep .git repository

---

## Support and Documentation

- **Setup Guide:** SETUP_GUIDE.md
- **API Documentation:** API_EXAMPLES.md
- **Full Documentation:** README.md (generated by setup.sh)
- **Troubleshooting:** See README.md and SETUP_GUIDE.md

---

## Version Information

- **Symfony:** 7.0.x
- **PHP:** 8.2
- **Nginx:** latest
- **Google Gemini:** 1.5 Pro
- **Docker:** 20.10+ recommended
- **Docker Compose:** 2.0+ recommended

---

## Success Criteria

âœ… All steps completed without errors
âœ… Containers running: `docker-compose ps` shows both "Up"
âœ… Health endpoint returns `{"status":"ok"}`
âœ… Analysis endpoint accepts POST requests and returns valid JSON
âœ… React frontend can make requests and receive responses
âœ… CORS headers present in OPTIONS requests
âœ… No errors in Docker logs: `docker-compose logs`

---

**You're ready for deployment!** ðŸš€

Start with: `bash setup.sh`
